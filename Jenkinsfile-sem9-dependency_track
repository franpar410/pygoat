pipeline {
    agent any

    stages {

        // ========================================================
        // 1Ô∏è‚É£ Etapa de An√°lisis con SonarQube
        // ========================================================
        stage('SonarQube analysis') {
            steps {
                withSonarQubeEnv('Sonarqube-docker') { 
                    script {
                        def scannerHome = tool 'sonarqube-scanner'
                        sh """
                            ${scannerHome}/bin/sonar-scanner \
                            -Dsonar.projectKey=pygoat-analysis \
                            -Dsonar.projectName=PyGoat \
                            -Dsonar.sources=. \
                            -Dsonar.python.version=3
                        """
                    }
                }
            }
        }

        // ========================================================
        // 2Ô∏è‚É£ Etapa de Control de Calidad (Quality Gate)
        // ========================================================
        stage('Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        // ========================================================
        // 3Ô∏è‚É£ Etapa de Configuraci√≥n del entorno Python
        // ========================================================
        stage('Setup Python environment') {
            agent {
                docker {
                    image 'python:3.10'
                    args '-u root:root'
                }
            }
            steps {
                sh '''
                    echo "Instalando dependencias de PyGoat..."
                    pip install --upgrade pip
                    pip install -r requirements.txt || echo "Archivo requirements.txt no encontrado"
                '''
            }
        }

        // ========================================================
        // 4Ô∏è‚É£ Etapa de Compilaci√≥n / Pruebas
        // ========================================================
        stage('Tests & Security Check') {
            agent {
                docker {
                    image 'python:3.10'
                    args '-u root:root'
                }
            }
            steps {
                sh '''
                    echo "Ejecutando tests unitarios..."
                    python manage.py test || echo "No hay tests configurados"

                    echo "Escaneo de seguridad con Bandit..."
                    pip install bandit
                    bandit -r . || true
                '''
            }
        }

        // ========================================================
        // 5Ô∏è‚É£ Etapa de Build (simulada)
        // ========================================================
        stage('Build') {
            agent {
                docker {
                    image 'python:3.10'
                    args '-u root:root'
                }
            }
            steps {
                sh 'echo "Construyendo artefacto de la aplicaci√≥n PyGoat (simulaci√≥n)..."'
            }
        }

        // ========================================================
        // 6Ô∏è‚É£ Etapa de Despliegue (simulada)
        // ========================================================
        stage('Deploy') {
            agent {
                docker {
                    image 'python:3.10'
                    args '-u root:root'
                }
            }
            steps {
                sh 'echo "Desplegando aplicaci√≥n PyGoat (simulaci√≥n)..."'
            }
        }

        // ========================================================
        // 7Ô∏è‚É£ Etapa de An√°lisis de Dependencias (Dependency-Track)
        // ========================================================
        stage('Dependency Track Scan') {
            agent {
                docker {
                    image 'python:3.10'
                    args '-u root:root'
                }
            }
            steps {
                script {
                    echo "Generando SBOM (CycloneDX) para PyGoat..."
                    sh '''
                        pip install cyclonedx-bom jq
                        cyclonedx-py --output bom.json
                    '''

                    echo "Subiendo SBOM a Dependency-Track..."
                    withCredentials([string(credentialsId: 'dependency-track-api-key', variable: 'DT_API_KEY')]) {
                        sh '''
                            curl -s -X POST "http://dependency-track:8081/api/v1/bom" \
                              -H "X-Api-Key: ${DT_API_KEY}" \
                              -H "Content-Type: multipart/form-data" \
                              -F "projectName=PyGoat" \
                              -F "autoCreate=true" \
                              -F "bom=@bom.json"
                        '''
                    }

                    echo "Esperando que Dependency-Track procese el SBOM..."
                    sleep 15

                    echo "Descargando m√©tricas del proyecto..."
                    withCredentials([string(credentialsId: 'dependency-track-api-key', variable: 'DT_API_KEY')]) {
                        sh '''
                            curl -s -X GET "http://dependency-track:8081/api/v1/project?name=PyGoat" \
                              -H "X-Api-Key: ${DT_API_KEY}" \
                              -o project.json

                            PROJECT_UUID=$(jq -r '.[0].uuid' project.json)

                            curl -s -X GET "http://dependency-track:8081/api/v1/project/${PROJECT_UUID}/metrics" \
                              -H "X-Api-Key: ${DT_API_KEY}" \
                              -o metrics.json

                            echo "üìä M√©tricas descargadas:"
                            cat metrics.json
                        '''
                    }

                    echo "Evaluando vulnerabilidades cr√≠ticas..."
                    def criticals = sh(script: "jq '.critical' metrics.json", returnStdout: true).trim().toInteger()

                    if (criticals > 0) {
                        error "‚ùå Se encontraron ${criticals} vulnerabilidades CR√çTICAS. Pipeline bloqueado."
                    } else {
                        echo "‚úÖ No se encontraron vulnerabilidades cr√≠ticas."
                    }

                    // Guardar reporte en Jenkins
                    archiveArtifacts artifacts: 'metrics.json', fingerprint: true
                }
            }
        }

        // ========================================================
        // 8Ô∏è‚É£ Etapa opcional de remediaci√≥n autom√°tica
        // ========================================================
        stage('Remediation (Optional)') {
            when { expression { return fileExists('requirements.txt') } }
            agent { docker { image 'python:3.10' } }
            steps {
                sh '''
                    echo "Analizando y actualizando dependencias inseguras..."
                    pip install safety
                    safety check --full-report || true
                    pip install --upgrade -r requirements.txt
                '''
            }
        }
    }

    // ========================================================
    // 9Ô∏è‚É£ Post: Acciones finales seg√∫n resultado
    // ========================================================
    post {
        success {
            echo "‚úÖ Pipeline ejecutado exitosamente y aprobado por SonarQube y Dependency-Track."
        }
        failure {
            echo "‚ùå Pipeline fall√≥. Revisar reportes en SonarQube (http://localhost:9000) o Dependency-Track (http://localhost:8081)"
        }
    }
}
