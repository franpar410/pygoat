pipeline {
    agent any

    environment {
        TRUFFLE_REPORT = 'trufflehog_report.json'
    }

    stages {
        stage('Preparación - limpieza') {
            steps {
                sh '''
                    rm -rf .trufflehog_test_repo
                    rm -f $TRUFFLE_REPORT
                '''
            }
        }

        stage('Crear repo de prueba con secreto detectable') {
            steps {
                sh '''
                    mkdir -p .trufflehog_test_repo
                    cd .trufflehog_test_repo
                    git init
                    git config user.email "jenkins@example.com"
                    git config user.name "Jenkins Bot"
                    echo "archivo normal sin secreto" > README.md
                    git add README.md
                    git commit -m "init"
                    echo "AWS_ACCESS_KEY_ID = AKIAEXAMPLEDUMMY1234" >> secret.txt
                    echo "DB_PASSWORD = SuperSecret123!" >> secret.txt
                    git add secret.txt
                    git commit -m "add detectable fake secrets"
                '''
            }
        }

        stage('Scan con TruffleHog') {
            steps {
                sh '''
                    docker run --rm \
                        -v $(pwd):/workspace \
                        -w /workspace \
                        trufflesecurity/trufflehog:latest \
                        filesystem --no-verification --json ./.trufflehog_test_repo > $TRUFFLE_REPORT
                '''
            }
        }

        stage('Analizar resultados') {
            steps {
                script {
                    def count = sh(
                        script: "grep -c DetectorType $TRUFFLE_REPORT || true",
                        returnStdout: true
                    ).trim()
                    echo "Número de hallazgos detectados: ${count}"
                    if (count.toInteger() > 0) {
                        echo "❌ Se detectaron secretos. Revisa el reporte JSON."
                    } else {
                        echo "✅ No se detectaron secretos."
                    }
                }
            }
        }

        stage('Archivar reporte JSON') {
            steps {
                archiveArtifacts artifacts: "$TRUFFLE_REPORT", fingerprint: true
            }
        }
    }

    post {
        always {
            echo "Fin del pipeline. Revisa el artefacto ${TRUFFLE_REPORT}."
        }
    }
}
