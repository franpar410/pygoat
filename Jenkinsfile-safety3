pipeline {
    agent any

    environment {
        REPORT_DIR = "${WORKSPACE}/reports"
    }

    stages {

        stage('SCA-Safety') {
            steps {
                script {
                    echo "ğŸ” Ejecutando anÃ¡lisis de dependencias con Safety usando Docker CLI..."

                    sh '''
                        set -e
                        mkdir -p .safetycache ${REPORT_DIR}

                        echo "ğŸ“¦ Lanzando contenedor Python para anÃ¡lisis..."
                        docker run --rm \
                            --entrypoint="" \
                            -v "$PWD":/app \
                            -v "$PWD/.safetycache:/root/.cache" \
                            -w /app \
                            python:3.11-slim bash -c "
                                set -e
                                apt-get update -qq &&
                                apt-get install -y --no-install-recommends gcc libpq-dev jq > /dev/null &&
                                pip install -q safety &&
                                if [ -f requirements.txt ]; then
                                    echo 'ğŸ“„ Instalando dependencias del proyecto...';
                                    pip install -q -r requirements.txt;
                                else
                                    echo 'âš ï¸ No se encontrÃ³ requirements.txt, creando uno temporal...';
                                    echo 'flask==2.0.1' > requirements.txt;
                                fi &&
                                echo 'ğŸš€ Ejecutando anÃ¡lisis con Safety...' &&
                                safety check --output json --file=requirements.txt > safety.json || true &&
                                safety check --output sarif --file=requirements.txt > safety.sarif || true
                            "

                        # Mover los reportes al directorio persistente
                        mv safety.json ${REPORT_DIR}/safety.json || echo 'âš ï¸ No se generÃ³ safety.json'
                        mv safety.sarif ${REPORT_DIR}/safety.sarif || echo 'âš ï¸ No se generÃ³ safety.sarif'
                    '''

                    echo "âœ… Reportes Safety generados en: ${REPORT_DIR}/"
                    sh 'ls -l ${REPORT_DIR} || true'
                }
            }
        }

        stage('Compilation') {
            steps {
                echo "âš™ï¸ Compilando aplicaciÃ³n..."
                sh 'sleep 1'
            }
        }

        stage('Build') {
            steps {
                echo "ğŸ—ï¸ Construyendo imagen Docker..."
                sh 'echo "docker build -t my-php-app ."'
            }
        }

        stage('Deploy') {
            steps {
                echo "ğŸš€ Desplegando contenedor..."
                sh 'echo "docker run my-php-app"'
            }
        }
    }

    post {
        always {
            echo "ğŸ“¦ Archivando artefactos..."
            archiveArtifacts artifacts: 'reports/safety.json, reports/safety.sarif', fingerprint: true, allowEmptyArchive: true
        }
        success {
            echo "âœ… Pipeline completado correctamente."
        }
        unstable {
            echo "âš ï¸ Pipeline marcado como inestable por vulnerabilidades detectadas."
        }
        failure {
            echo "âŒ Pipeline fallido."
        }
    }
}
