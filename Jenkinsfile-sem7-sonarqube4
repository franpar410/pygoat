pipeline {
    agent {
        docker {
            image 'python:3.10-slim'
            args '-u root:root' // Necesario para instalar paquetes dentro del contenedor
        }
    }

    environment {
        // Variables de entorno para SonarQube
        SONARQUBE_SCANNER = '/usr/local/bin/sonar-scanner'
        VENV_DIR = 'venv'
    }

    stages {
        stage('Prepare Docker Environment') {
            steps {
                echo "üîß Instalando dependencias necesarias en el contenedor..."
                sh '''
                    apt-get update
                    apt-get install -y python3-venv build-essential curl nodejs npm git
                    curl -sSLo /usr/local/bin/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.9.2.67188-linux.zip
                    apt-get install -y unzip
                    unzip /usr/local/bin/sonar-scanner.zip -d /usr/local/bin/
                    mv /usr/local/bin/sonar-scanner-4.9.2.67188-linux /usr/local/bin/sonar-scanner
                    chmod +x /usr/local/bin/sonar-scanner/bin/sonar-scanner
                '''
            }
        }

        stage('Checkout') {
            steps {
                echo "üì• Clonando el repositorio..."
                checkout scm
            }
        }

        stage('SonarQube analysis') {
            steps {
                echo "üîç Iniciando an√°lisis con SonarQube..."
                withSonarQubeEnv('Sonarqube-docker') {
                    sh '''
                        /usr/local/bin/sonar-scanner/bin/sonar-scanner \
                        -Dsonar.projectKey=pygoat-analysis \
                        -Dsonar.projectName=PyGoat \
                        -Dsonar.sources=. \
                        -Dsonar.language=py \
                        -Dsonar.python.version=3.10 \
                        -Dsonar.host.url=http://sonarqube:9000
                    '''
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time: 3, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Setup Python environment') {
            steps {
                echo "üêç Configurando entorno virtual Python..."
                sh '''
                    python3 -m venv ${VENV_DIR}
                    source ${VENV_DIR}/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }

        stage('Tests & Security Check') {
            steps {
                echo "üß™ Ejecutando pruebas y Bandit..."
                sh '''
                    source ${VENV_DIR}/bin/activate
                    python manage.py test
                    bandit -r pygoat
                '''
            }
        }

        stage('Build') {
            steps {
                echo "‚öôÔ∏è Compilando proyecto Django..."
                sh '''
                    source ${VENV_DIR}/bin/activate
                    python manage.py check
                '''
            }
        }

        stage('Deploy') {
            steps {
                echo "üöÄ Desplegando aplicaci√≥n (simulado)..."
                sh 'echo "Deploy step would go here"'
            }
        }
    }

    post {
        success {
            echo "‚úÖ Pipeline completado exitosamente."
        }
        failure {
            echo "‚ùå Pipeline fall√≥. Revisar SonarQube y logs de Jenkins."
        }
    }
}
