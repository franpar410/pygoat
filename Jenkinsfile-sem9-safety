pipeline {
    agent any

    stages {

        // ========================================================
        // 1Ô∏è‚É£ An√°lisis SonarQube
        // ========================================================
        stage('SonarQube analysis') {
            steps {
                withSonarQubeEnv('Sonarqube-docker') { 
                    script {
                        def scannerHome = tool 'sonarqube-scanner'
                        sh """
                            ${scannerHome}/bin/sonar-scanner \
                            -Dsonar.projectKey=pygoat-analysis \
                            -Dsonar.projectName=PyGoat \
                            -Dsonar.sources=. \
                            -Dsonar.python.version=3
                        """
                    }
                }
            }
        }

        // ========================================================
        // 2Ô∏è‚É£ Quality Gate
        // ========================================================
        stage('Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        // ========================================================
        // 3Ô∏è‚É£ Setup Python environment
        // ========================================================
        stage('Setup Python environment') {
            agent {
                docker {
                    image 'python:3.10'
                    args '-u root:root'
                }
            }
            steps {
                sh '''
                    echo "Instalando dependencias de PyGoat..."
                    pip install --upgrade pip
                    pip install -r requirements.txt || echo "Archivo requirements.txt no encontrado"
                '''
            }
        }

        // ========================================================
        // 4Ô∏è‚É£ Tests y Bandit
        // ========================================================
        stage('Tests & Security Check') {
            agent {
                docker {
                    image 'python:3.10'
                    args '-u root:root'
                }
            }
            steps {
                sh '''
                    echo "Ejecutando tests unitarios..."
                    python manage.py test || echo "No hay tests configurados"

                    echo "Escaneo de seguridad con Bandit..."
                    pip install bandit
                    bandit -r . -f json -o bandit-report.json || true
                '''
                archiveArtifacts artifacts: 'bandit-report.json', fingerprint: true
            }
        }

        // ========================================================
        // 5Ô∏è‚É£ Dependencias seguras (Safety)
        // ========================================================
        stage('Security Dependencies (Safety)') {
            agent {
                docker {
                    image 'python:3.10'
                    args '-u root:root'
                }
            }
            steps {
                sh '''
                    echo "Analizando vulnerabilidades en dependencias con Safety..."
                    pip install safety
                    safety check --json > safety-report.json || true
                '''
                // Guardamos el reporte como artefacto
                archiveArtifacts artifacts: 'safety-report.json', fingerprint: true

                // Opcional: bloquear el pipeline si hay vulnerabilidades cr√≠ticas
                script {
                    def safetyResult = sh(script: "cat safety-report.json", returnStdout: true).trim()
                    if (safetyResult.contains('"severity": "critical"') || safetyResult.contains('"severity": "high"')) {
                        error("üö® Vulnerabilidades cr√≠ticas detectadas. Pipeline detenido.")
                    } else {
                        echo "‚úÖ No se encontraron vulnerabilidades cr√≠ticas."
                    }
                }
            }
        }

        // ========================================================
        // 6Ô∏è‚É£ Build (simulada)
        // ========================================================
        stage('Build') {
            agent {
                docker {
                    image 'python:3.10'
                    args '-u root:root'
                }
            }
            steps {
                sh 'echo "Construyendo artefacto de la aplicaci√≥n PyGoat (simulaci√≥n)..."'
            }
        }

        // ========================================================
        // 7Ô∏è‚É£ Deploy (simulada)
        // ========================================================
        stage('Deploy') {
            agent {
                docker {
                    image 'python:3.10'
                    args '-u root:root'
                }
            }
            steps {
                sh 'echo "Desplegando aplicaci√≥n PyGoat (simulaci√≥n)..."'
            }
        }
    }

    // ========================================================
    // 8Ô∏è‚É£ Post pipeline
    // ========================================================
    post {
        success {
            echo "‚úÖ Pipeline ejecutado exitosamente y aprobado por SonarQube y Safety."
        }
        failure {
            echo "‚ùå Pipeline fall√≥. Revisar reporte de SonarQube o Safety en Jenkins."
        }
    }
}
