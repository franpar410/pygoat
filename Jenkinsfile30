node {
    def APP_NAME    = "PyGoat"
    def APP_VERSION = "1.0"

    try {
        stage('Checkout SCM') {
            checkout scm
        }

        stage('Security Analysis (SAST & Secrets)') {
            echo "üõ°Ô∏è Ejecutando Bandit y Gitleaks..."
            // Bandit - An√°lisis de c√≥digo est√°tico
            sh 'docker run --rm -v "$PWD":/src -w /src python:3.11-slim sh -c "pip install --no-cache-dir bandit && bandit -r . -f json -o bandit-report.json --exit-zero"'
            // Gitleaks - Detecci√≥n de secretos
            sh 'docker run --rm -v "$PWD":/repo zricethezav/gitleaks:latest detect --source=/repo --report-format json --report-path /repo/gitleaks-report.json --exit-code 0'
        }

        stage('SCA - Dependency-Track') {
            echo "üì¶ Generando SBOM y subiendo a Dependency-Track..."
            withCredentials([
                string(credentialsId: 'dependency-track-api-key', variable: 'DT_API_KEY'),
                string(credentialsId: 'dependency-track-url',     variable: 'DT_URL')
            ]) {
                // Generar bom.xml con Syft
                sh 'docker run --rm -v "$PWD":/src anchore/syft:latest dir:/src -o cyclonedx-xml=/src/bom.xml'
                
                // Subir a Dependency-Track (Usa IP 172.18.0.5:8080)
                sh "curl -s -X POST \"\$DT_URL/api/v1/bom\" -H \"X-Api-Key: \$DT_API_KEY\" -F \"autoCreate=true\" -F \"projectName=${APP_NAME}\" -F \"projectVersion=${APP_VERSION}\" -F \"bom=@bom.xml\""
            }
        }

        stage('Centralize in DefectDojo') {
            withCredentials([
                string(credentialsId: 'DEFECTDOJO_API_KEY', variable: 'DD_API_KEY'),
                string(credentialsId: 'DEFECTDOJO_URL',     variable: 'DD_URL')
            ]) {
                echo "üì§ Importando resultados a DefectDojo..."
                
                def commonArgs = "-H 'Authorization: Token \$DD_API_KEY' -F 'product_name=${APP_NAME}' -F 'engagement_name=PyGoat CI/CD' -F 'active=true' -F 'verified=false'"

                // 1. Importar Bandit
                sh "curl -s -X POST \"\$DD_URL/api/v2/import-scan/\" ${commonArgs} -F 'scan_type=Bandit Scan' -F 'file=@bandit-report.json'"
                
                // 2. Importar Gitleaks
                sh "curl -s -X POST \"\$DD_URL/api/v2/import-scan/\" ${commonArgs} -F 'scan_type=Gitleaks Scan' -F 'file=@gitleaks-report.json'"
                
                // 3. Importar SCA (CycloneDX)
                sh "curl -s -X POST \"\$DD_URL/api/v2/import-scan/\" ${commonArgs} -F 'scan_type=CycloneDX Scan' -F 'file=@bom.xml'"
            }
        }

    } catch (Exception e) {
        currentBuild.result = 'FAILURE'
        echo "Error en el pipeline: ${e.message}"
    } finally {
        echo "üìé Guardando artefactos de seguridad..."
        archiveArtifacts artifacts: '*.json,*.xml', allowEmptyArchive: true
    }
}
