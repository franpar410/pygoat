node {
    def APP_NAME    = "PyGoat"
    def APP_VERSION = "1.0"

    try {
        stage('Checkout SCM') {
            checkout scm
        }

        stage('SAST - Bandit') {
            echo "üõ°Ô∏è Running Bandit SAST analysis"
            sh '''
            docker run --rm \
              -v "$PWD":/src \
              -w /src \
              python:3.11-slim \
              sh -c "
                pip install --no-cache-dir bandit && \
                bandit -r . -f json -o bandit-report.json --exit-zero
              "
            '''
            
            // SECURITY GATE: Bandit
            script {
                def report = readJSON file: 'bandit-report.json'
                int highIssues = 0
                int criticalIssues = 0
                
                report.results.each { issue ->
                    if (issue.issue_severity == 'HIGH') highIssues++
                    if (issue.issue_severity == 'CRITICAL') criticalIssues++
                }

                if (highIssues > 0 || criticalIssues > 0) {
                    echo "‚ö†Ô∏è Security Gate FAILED (Bandit): Found ${highIssues} High and ${criticalIssues} Critical issues."
                    currentBuild.result = 'UNSTABLE'
                }
            }
        }

        stage('Upload Bandit to DefectDojo') {
            withCredentials([
                string(credentialsId: 'DEFECTDOJO_API_KEY', variable: 'DD_API_KEY'),
                string(credentialsId: 'DEFECTDOJO_URL',     variable: 'DD_URL')
            ]) {
                sh '''
                curl -s -X POST "$DD_URL/api/v2/import-scan/" \
                  -H "Authorization: Token $DD_API_KEY" \
                  -F "scan_type=Bandit Scan" \
                  -F "product_name=${APP_NAME}" \
                  -F "engagement_name=PyGoat CI/CD" \
                  -F "file=@bandit-report.json"
                '''
            }
        }

        stage('SCA - Dependency-Track') {
            echo "üì¶ Generating SBOM and sending to Dependency-Track"
            withCredentials([
                string(credentialsId: 'dependency-track-api-key', variable: 'DT_API_KEY'),
                string(credentialsId: 'dependency-track-url',     variable: 'DT_URL')
            ]) {
                // Generar SBOM
                sh 'docker run --rm -v "$PWD":/src anchore/syft:latest dir:/src -o cyclonedx-xml=/src/bom.xml'

                // Subir a Dependency-Track y capturar el token de carga
                def response = sh(
                    script: """
                        curl -s -X POST "$DT_URL/api/v1/bom" \
                        -H "X-Api-Key: $DT_API_KEY" \
                        -F "autoCreate=true" \
                        -F "projectName=$APP_NAME" \
                        -F "projectVersion=$APP_VERSION" \
                        -F "bom=@bom.xml"
                    """, 
                    returnStdout: true
                ).trim()
                
                echo "SBOM Uploaded. Waiting for analysis..."
                sleep 10 // Tiempo de cortes√≠a para procesar

                // SECURITY GATE: Dependency-Track
                // Consultamos las m√©tricas del proyecto
                def projectInfo = sh(
                    script: """
                        curl -s -X GET "$DT_URL/api/v1/project/lookup?name=$APP_NAME&version=$APP_VERSION" \
                        -H "X-Api-Key: $DT_API_KEY" -H "Accept: application/json"
                    """,
                    returnStdout: true
                ).trim()
                
                def project = readJSON text: projectInfo
                def critical = project.lastBomImportScanStatus?.critical ?: 0 // Ajustar seg√∫n versi√≥n de API
                def high = project.metrics?.high ?: 0

                if (high > 0 || critical > 0) {
                    echo "‚ö†Ô∏è Security Gate FAILED (SCA): Found ${high} High and ${critical} Critical vulnerabilities."
                    currentBuild.result = 'UNSTABLE'
                }
            }
        }

        // ... Resto de etapas (Gitleaks) se mantienen igual ...

    } catch (Exception e) {
        currentBuild.result = 'FAILURE'
        throw e
    } finally {
        echo "üìé Archiving security artifacts"
        archiveArtifacts artifacts: '*.json,*.xml', fingerprint: true
    }
}
