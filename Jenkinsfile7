pipeline {
    agent any

    environment {
        LAB_MODE = "true"
        DEFECTDOJO_URL = credentials('DEFECTDOJO_URL')
        DEFECTDOJO_API_KEY = credentials('DEFECTDOJO_API_KEY')
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Bandit SAST') {
            steps {
                sh '''
                    echo "üõ°Ô∏è Running Bandit SAST analysis (Lab Mode)..."
                    docker run --rm \
                      -v "$PWD:/src" \
                      python:3.12-slim sh -c "
                        pip install --no-cache-dir bandit &&
                        bandit -r /src -f json -o /src/bandit-report.json || true
                      "
                '''
            }
        }

        stage('Bandit Gate (Lab Mode)') {
            steps {
                sh '''
                    echo "üîé Evaluating Bandit findings (non-blocking)..."
                    python3 - << 'EOF'
import json

try:
    with open("bandit-report.json") as f:
        data = json.load(f)
except Exception as e:
    print("‚ö†Ô∏è Could not read bandit-report.json:", e)
    exit(0)

issues = [
    i for i in data.get("results", [])
    if i.get("issue_severity") in ("HIGH", "CRITICAL")
]

if issues:
    print("‚ö†Ô∏è Bandit HIGH/CRITICAL findings:")
    for i in issues:
        print(f"- {i['issue_severity']} | {i['issue_text']} | {i['filename']}:{i['line_number']}")
else:
    print("‚úÖ No HIGH/CRITICAL findings")

print("‚û°Ô∏è Continuing pipeline (Lab Mode)")
EOF
                '''
            }
        }

        stage('Upload Bandit to DefectDojo (Non-Blocking)') {
            steps {
                catchError(buildResult: 'SUCCESS', stageResult: 'UNSTABLE') {
                    sh '''
                        echo "üì§ Uploading Bandit report to DefectDojo (best effort)..."
                        curl -s -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
                          -H "Authorization: Token $DEFECTDOJO_API_KEY" \
                          -F scan_type="Bandit Scan" \
                          -F product_name="PyGoat" \
                          -F engagement_name="PyGoat CI/CD" \
                          -F file=@bandit.json || true
                        echo "‚ÑπÔ∏è DefectDojo upload attempted (pipeline will not fail)"
                    '''
                }
            }
        }

        stage('Gitleaks Secrets Scan (Lab Mode)') {
            steps {
                sh '''
                    echo "üîê Gitleaks skipped (Lab Mode placeholder)"
                '''
            }
        }
    }

    post {
        always {
            echo "üìé Archiving security artifacts..."
            archiveArtifacts artifacts: '*.json', allowEmptyArchive: true
            echo "‚úÖ Pipeline completed (Lab Mode)"
        }
    }
}
