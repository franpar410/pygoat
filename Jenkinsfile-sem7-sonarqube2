pipeline {
    agent any

    environment {
        // Nombre del proyecto en SonarQube
        SONAR_PROJECT_KEY = "pygoat-analysis"
        SONAR_PROJECT_NAME = "PyGoat"
        // Configuraci√≥n de SonarQube definida en Jenkins
        SONARQUBE_ENV = "Sonarqube-docker"
        // URL de SonarQube dentro de la red Docker
        SONAR_HOST_URL = "http://sonarqube:9000"
        // Token de SonarQube (configurado en Jenkins global credentials si se requiere)
        // SONAR_AUTH_TOKEN = credentials('sonarqube-token')
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'üì• Clonando el repositorio desde GitHub...'
                git branch: 'master', url: 'https://github.com/franpar410/pygoat.git'
            }
        }

        stage('SonarQube analysis') {
            steps {
                script {
                    echo 'üîç Iniciando an√°lisis est√°tico con SonarQube...'
                    withSonarQubeEnv("${SONARQUBE_ENV}") {
                        sh """
                            /var/jenkins_home/tools/hudson.plugins.sonar.SonarRunnerInstallation/sonarqube-scanner/bin/sonar-scanner \
                            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                            -Dsonar.projectName=${SONAR_PROJECT_NAME} \
                            -Dsonar.sources=. \
                            -Dsonar.language=py \
                            -Dsonar.python.version=3.10 \
                            -Dsonar.host.url=${SONAR_HOST_URL}
                        """
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time: 3, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Setup Python environment') {
            steps {
                echo 'üêç Verificando entorno Python en el contenedor Jenkins...'
                sh '''
                    python3 --version || echo "Python no encontrado"
                    pip3 --version || echo "pip no encontrado"
                    which bandit || (echo "Bandit no instalado, instalando..." && pip3 install bandit)
                '''
            }
        }

        stage('Tests & Security Check') {
            steps {
                echo 'üß™ Ejecutando pruebas unitarias y an√°lisis de seguridad...'
                sh '''
                    echo "Ejecutando Bandit..."
                    bandit -r pygoat || true
                '''
            }
        }

        stage('Build') {
            steps {
                echo '‚öôÔ∏è Compilando proyecto Django (PyGoat)...'
                sh '''
                    python3 manage.py check
                '''
            }
        }

        stage('Deploy') {
            steps {
                echo 'üöÄ Simulando despliegue (placeholder)...'
            }
        }
    }

    post {
        success {
            echo '‚úÖ Pipeline completado exitosamente.'
        }
        failure {
            echo '‚ùå Pipeline fall√≥. Revisar reporte de SonarQube en Jenkins o en http://localhost:9000'
        }
    }
}
